# Сессия: Анализ требований — Редактор блюпринтов

---

## Полный диалог

**User:** проанализируй секцию с редактором блюпринтов, я буду докидывать требования, а ты задавать вопросы и ликвидировать противоречия

**Claude:** Проанализировал секцию (строки 510–532). Вот что нашёл:

### Противоречия

**1. Удаление вершины/ребра ломает полигон**
- "Удалить ребро = удалить обе точки" → из треугольника (3 вершины) останется 1 вершина. Это не фигура.
- "Удалить точку" → из треугольника остаётся 2 вершины. Тоже не фигура.
- Поведение не определено: коллапс фигуры? Открытый контур? Запрет удаления?

**2. "Вершина и ребро не могут переместиться внутрь полигона"**
Когда двигаешь вершину треугольника — она сама является границей. Что значит "внутрь"? Есть три возможных интерпретации:
- нельзя сделать полигон вогнутым (self-intersecting)
- нельзя пересечь соседние рёбра
- нельзя выйти за пределы hull-а

**3. "Перемещается всё множество полигонов, соединённое рёбрами"**
Если полигоны соединены общими рёбрами — это одна фигура, не несколько. Если у каждого свои рёбра — они не "соединены". Что именно считается "соединённым множеством"?

### Вопросы

**Q1.** Что происходит при удалении вершины из треугольника (минимальный полигон)? Запрет операции / фигура коллапсирует / удаляется вся фигура?

**Q2.** Полигоны должны быть только выпуклыми (как в физике Aether) или произвольной формы, с последующей декомпозицией под капотом?

**Q3.** Что такое "множество полигонов, соединённых рёбрами" — все фигуры на сцене, или фигуры, разделяющие общие вершины?

**Q4.** ПКМ с зажатием над ребром: сначала удаляет или сначала двигает камеру? Порог удержания есть?

**Q5.** Редактор — это отдельный исполняемый режим (`--editor` флаг?) или переключается в рантайме?

---

**User:** 1) нельзя удалить вершину из треугольника, являющегося одиночкой 2) любая фигура в редакторе - набор треугольников. Если ты добавляешь +1 вершину - это происходит только из двух других вершин, то есть происходит добавление +1 треугольника 3) множество треугольников с общими вершинами 4) будем разделять клик на месте и драг правым кликом, поэтому просто клик - удаление, драг - камера. 5) редактор - одно из состояний игры в рантайме, в него можно перейти по нажатию на F1 будучи в состоянии главного меню

**Claude:** Отлично, модель становится понятнее. Но новые ответы порождают новые противоречия.

### Новые противоречия

**1. "Удалить ребро = удалить обе точки" vs меш треугольников**
В меше вершины разделяются между треугольниками. Ребро между двумя треугольниками — его вершины принадлежат обоим. "Удалить обе точки" = сломать оба треугольника.

Варианты что может значить "удалить ребро":
- удалить треугольник(и), которым принадлежит это ребро
- разъединить треугольники по этому ребру (они становятся отдельными мешами)
- что-то ещё?

**2. "Удалить вершину" vs общая вершина меша**
Если вершина входит в 3 треугольника — что происходит с остальными двумя при удалении? Все три треугольника удаляются? Дыра в меше?

**3. "LMB drag по ребру = обе вершины следуют за мышью" vs общее ребро**
Если ребро делится двумя треугольниками — перетаскивание его деформирует оба. Это намеренно?

**4. "Вершина не может переместиться внутрь полигона" — какого?**
В меше треугольников — это ограничение на уровне отдельного треугольника (не инвертировать его) или на уровне всего меша (не заходить внутрь общей фигуры)?

### Новые вопросы

**Q1.** Как добавляется новый треугольник? Ты сказал "из двух других вершин" — это значит: навести на ребро → куда-то кликнуть → появляется новая вершина + треугольник? Какой жест?

**Q2.** Может ли на сцене быть несколько несвязанных мешей одновременно, или всегда один связный меш?

---

**User:** давай пока без удаления рёбер, только вершины. и без перемещения рёбер. перемещаем только вершины и удаляем только вершины. если удалить вершину, а она цепляет несколько треугольников - пытаемся соединить осиротевшие вершины в другие треугольники по возможности без пересечений. осиротевшая вершина без своей тройки удаляется. новый треугольник создается путём выделения двух вершин(это шифт+лкм) и лкм на любой свободной области вокруг меша, в которой можно создать "непротиворечивый" треугольник(то есть без пересечений)

**Claude:** Упростилось, но появились новые вопросы. Пройдусь по каждому нюансу.

### Противоречия

**1. Shift+LMB на вершине vs LMB drag на вершине**
Оба жеста начинаются с нажатия LMB на вершине. Как система различает "начало выделения" от "начало перемещения"? Нужен порог: если мышь не сдвинулась — это выделение, если сдвинулась — это drag?

**2. LMB по свободной области в режиме выделения vs перемещение меша**
Оригинальный spec: "LMB внутри рёбер = перемещает весь меш". Если выделены 2 вершины и я кликаю внутри меша — это создание треугольника или перемещение? Нужен приоритет.

### Вопросы

**Q1.** Алгоритм переподключения осиротевших вершин — автоматический или ручной? При удалении V, вокруг дыры могут быть 4–6 вершин с несколькими валидными триангуляциями. Система выбирает автоматически (ear-clipping?), или игрок сам дотриангулирует руками?

**Q2.** Что очищает выделение двух вершин (Shift+LMB)? Escape? Клик без Shift? Повторный Shift+LMB по той же вершине снимает выделение?

**Q3.** Есть ли превью треугольника при наведении мыши после выбора двух вершин? То есть видно куда он "встанет" до клика?

**Q4.** Можно ли выбрать две несмежные вершины (без общего ребра)? Если да — система пытается создать треугольник, проверяя что новые рёбра не пересекают существующие?

**Q5.** Можно ли создать полностью новый несвязный меш? Текущий флоу требует выбрать 2 существующие вершины → новый треугольник всегда присоединяется к существующему. Как создать второй независимый объект на сцене?

---

**User:** противоречия в жестах лкм на вершине вроде бы нет. нажатие провоцирует выделение вершины(она стала синей, юзер ещё не отпустил кнопку), а движение после зажатия провоцирует перемещение выбранной вершины. если юзер начал драг, а было выбрано несколько вершин - то выбранной остается только последняя и драгается куда юзер ведет мышь. если после выделения вершин кликнуть внутри меша - выделение спадет. две несмежные вершины выбрать нельзя. я могу давать требования вразнобой, но ты их структурируй сам и докидывай вопросы по поводу того, чего не хватает

**Claude:** Структурирую всё накопленное, отмечу gaps.

---

## Спецификация (текущее состояние)

### Переход в редактор
- F1 из состояния главного меню → состояние `BlueprintEditor`
- Собирается упрощённый игровой мир
- Открывается untitled-префаб: один треугольник в центре

### Сцена
- Красная точка в (0,0) — виртуальный центр объекта
- Всё на сцене — треугольники с общими вершинами (меш)

### Рендер
- Вершины — синие точки
- Рёбра — линии между вершинами
- Hover на вершине / ребре → смена цвета

### Выделение
- LMB press на вершине → вершина выделена (держим кнопку)
- Shift+LMB на смежной вершине → добавить в выделение (макс. 2)
- Несмежные вершины выбрать нельзя
- Клик внутри меша → сброс выделения

### Перемещение вершины
- LMB press на вершине + drag → тянем вершину за мышью
- Если было выделено несколько — только последняя тянется, остальные сбрасываются
- Ограничение: "нельзя переместить внутрь полигона" — трактовка не уточнена (см. Q6)

### Создание треугольника
- Выделить 2 смежные вершины (Shift+LMB)
- LMB по валидной свободной области → новая вершина там + новый треугольник
- Валидность: новые рёбра не пересекают существующие

### Удаление вершины
- RMB click на вершине → удалить
- Запрет: нельзя удалить вершину одиночного треугольника
- После удаления: система автоматически пытается перетриангулировать осиротевшие вершины без пересечений
- Осиротевшая вершина без валидной тройки → удаляется

### Камера
- RMB drag по пустой области → панорамирование (Figma-стиль)
- Зум — не уточнён (см. Q5)

### Перемещение всего меша
- LMB drag внутри меша (без выделенных вершин) → весь связный меш двигается

---

## Открытые вопросы (ждут ответа)

- **Q1.** Алгоритм перетриангуляции после удаления вершины — автоматический (ear-clipping по дыре) или игрок дотриангулирует вручную?
- **Q2.** Что ещё сбрасывает выделение кроме клика внутри меша? Escape? Клик по пустой области снаружи?
- **Q3.** Есть ли превью нового треугольника при наведении в режиме "2 вершины выделены"?
- **Q4.** Может ли на сцене быть несколько несвязных мешей? Если да — как создать второй?
- **Q5.** Зум — колёсиком мыши?
- **Q6.** "Вершина не может переместиться внутрь полигона" — запрет на инверсию своего треугольника или запрет на пересечение любых рёбер меша?
- **Q7.** Как сохранить / выйти из редактора?

---

## Разрешённые противоречия

| Противоречие | Решение |
|---|---|
| LMB select vs LMB drag | Press = select, движение после = drag |
| Drag при нескольких выделенных | Только последняя тянется, остальные сбрасываются |
| Клик внутри меша в режиме выделения | Сбрасывает выделение |
| Несмежные вершины | Нельзя выбрать две несмежные |
| Удаление из одиночного треугольника | Запрещено |
| RMB click vs RMB drag | Click = удаление вершины, drag = камера |
