# Сессия: Анализ требований — Редактор блюпринтов

---

## Спецификация (текущее состояние)

### Переход в редактор
- F1 из состояния главного меню → состояние `BlueprintEditor`
- Собирается упрощённый игровой мир
- Открывается untitled-префаб: один треугольник в центре

### Сцена
- Красная точка в (0,0) — виртуальный центр объекта
- Всё на сцене — треугольники с общими вершинами (меш)
- Только один меш на сцене, нельзя создать второй, нельзя удалить последний треугольник полностью

### Рендер
- Вершины — синие точки
- Рёбра — линии между вершинами
- Hover на вершине / ребре → смена цвета

### Выделение
- LMB press на вершине → вершина выделена (предыдущее выделение сбрасывается)
- Shift+LMB на смежной вершине → добавить в выделение (макс. 2)
- Несмежные вершины выбрать нельзя
- Сброс выделения: клик внутри меша, LMB на другой вершине (без Shift), создание треугольника
- Escape, клик снаружи меша — выделение НЕ сбрасывают

### Перемещение вершины
- LMB press на вершине + drag → тянем вершину за мышью
- Если было выделено несколько — только последняя тянется, остальные сбрасываются
- Ограничение: ни одно ребро меша не должно пересекать другое ребро этого же меша

### Создание треугольника
- Выделить 2 смежные вершины (Shift+LMB)
- Навести мышь → превью треугольника следует за курсором:
  - Синий — позиция валидна (новые рёбра не пересекают существующие)
  - Красный — позиция невалидна
- LMB по валидной области → новая вершина + новый треугольник
- После создания: выделение сбрасывается

### Удаление вершины
- RMB click на вершине → удалить
- Запрет: нельзя удалить вершину одиночного треугольника (≤3 вершин в меше)
- После удаления: система автоматически перетриангулирует осиротевшие вершины (ear-clipping по дыре), без пересечений
- Осиротевшая вершина без валидной тройки → удаляется

### Камера
- RMB drag по пустой области → панорамирование (Figma-стиль)
- Зум — колёсико мыши

### Перемещение всего меша
- LMB drag внутри меша (без выделенных вершин) → весь связный меш двигается

### Сайдбар
- Список всех доступных префабов для редактирования
- При запуске — только untitled, редактируем его
- После любых изменений рядом с именем префаба появляются две иконки-кнопки:
  - **Сохранить** — записывает JSON-файл на диск в папку `Prefabs/`
  - **Откатить** — приводит префаб к последнему сохранённому состоянию
- В режиме редактора: файлы хранятся в `Prefabs/`
- В игре: пользовательские префабы хранятся в игровом мире (отдельно от редакторских)

---

## Техническая архитектура

### Редактор как ECS-сущность

Редактор — не отдельное приложение, а ECS-сущность с компонентом-маркером `Blueprint`.
Работает в мультиплеере по тем же правилам, что спавнер и дрон:
- Является `ControlSubject` — в него можно "вселиться" через стандартный механизм управления
- При вселении игрок поставляет инпут в виде координат курсора и экшенов мыши

### Типы инпута

`ControlSubjectInput<T>` — компонент на Blueprint-сущности, в поле `T Payload` лежит пейлоад конкретного типа инпута.

| Тип `T` | Поля пейлоада | Смысл |
|---------|--------------|-------|
| `CursorInput` | `Vector2 WorldPosition` | Текущая позиция курсора в мировых координатах |
| `CursorLeftMoveAction` | `Vector2 Start`, `Vector2 End`, `bool PreviouslyActive` | LMB зажат + движение мыши; `PreviouslyActive = false` = первый фрейм (press) |
| `CursorRightMoveAction` | `Vector2 Start`, `Vector2 End` | RMB зажат + движение; если `Start == End` (delta = 0) — трактуется как click |
| `InputExclusive` | `int OwnerStableId` | Маркер эксклюзивного контроля (см. ниже) |
| `ShiftModifier` | — | Маркер: Shift зажат в этом фрейме |
| `ScrollAction` | `float Delta` | Зум колёсиком; **не уходит на сервер**, применяется клиентом напрямую к сущности таргета камеры |

### Эксклюзивный контроль: `ControlSubjectInput<InputExclusive>`

Двойная роль:
1. **Обычный инпут** — любой вселившийся игрок может отправить его (нажатие F "взять контроль")
2. **Системный маркер** — если компонент присутствует на сущности, InputSystem применяет правило:
   - Инпуты любого типа принимаются **только** от `OwnerStableId`, записанного в этом компоненте
   - Исключение: `ControlSubjectInput<InputExclusive>` принимается от **всех** — это единственный способ перехватить контроль

**Поведение при нескольких игроках в редакторе:**
- Оба вселились, оба видят редактор
- Кто последним нажал F → его `OwnerStableId` записывается в `ControlSubjectInput<InputExclusive>`
- Только он управляет; второй может нажать F чтобы перехватить

### Системы редактора

**`BlueprintCursorSystem`**
- Query: `q(Blueprint, ControlSubjectInput<CursorInput>)`
- Рисует кружок-курсор в позиции мыши
- Проходится по вершинам меша, выставляет им hover-состояние по proximity

**`BlueprintVertexSelectSystem`**
- Query: `q(Blueprint, ControlSubjectInput<CursorLeftMoveAction>)` где `Payload.PreviouslyActive = false`
- На первом фрейме LMB drag: помечает вершину под курсором как выбранную

**`BlueprintVertexMoveSystem`**
- Query: `q(Blueprint, ControlSubjectInput<CursorLeftMoveAction>)`
- Пока LMB зажат и есть движение: двигает выбранную вершину на `Delta`

**`BlueprintCameraSystem`**
- Query: `q(Blueprint, ControlSubjectInput<CursorRightMoveAction>)`
- Панорамирует камеру на `Delta`

---

## Открытых технических вопросов нет

---

## Разрешённые противоречия

| Противоречие | Решение |
|---|---|
| LMB select vs LMB drag | Press = select, движение после = drag |
| Drag при нескольких выделенных | Только последняя тянется, остальные сбрасываются |
| LMB на другой вершине без Shift | Сбрасывает предыдущее выделение |
| Клик внутри меша в режиме выделения | Сбрасывает выделение |
| Escape / клик снаружи меша | Выделение не сбрасывают |
| Несмежные вершины | Нельзя выбрать две несмежные |
| Удаление из одиночного треугольника | Запрещено |
| RMB click vs RMB drag | Click = удаление вершины, drag = камера |
| Перетриангуляция после удаления | Автоматическая (ear-clipping) |
| Несколько мешей на сцене | Нельзя, всегда один меш |
| "Нельзя переместить внутрь полигона" | Ни одно ребро не должно пересекать другое ребро меша |
| Создание треугольника сбрасывает выделение | Да |
